name: Xbox-nxdk

on: [push, pull_request]

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release

jobs:
  xbox:
    # `ubuntu-latest` is currently 20.04 but we require a newer clang.
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: diablo
            cmakeargs: '-DUSE_PATCH=OFF'
            artifact: 'diablo-push-xbox-nxdk'
          - name: hellfire+patch
            cmakeargs: '-DHELLFIRE=ON'
            artifact: 'hellfire-push-xbox-nxdkp'
    env:
      NXDK_DIR: /opt/nxdk
    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        fetch-tags: true
        #fetch-depth: 0

    - name: Create Build Environment
      run: sudo apt-get update && sudo apt-get install -y clang llvm lld bison flex cmake git

    - name: Clone NXDK Repo
      shell: bash
    #  #run: git clone --recursive --depth 1 --branch devilutionx https://github.com/glebm/nxdk.git "$NXDK_DIR"
      #run: git clone --recursive --depth 1 https://github.com/XboxDev/nxdk.git "$NXDK_DIR"
      run:
        #git clone --recursive --depth 1 https://github.com/pionere/nxdk.git "$NXDK_DIR"
        git clone --recursive --depth 1 --branch mkopts https://github.com/pionere/nxdk.git "$NXDK_DIR"
        #git checkout a7d529e8c2fd4d71ea6bcadc3bb4eba11e5b7ff9
    #- name: Clone NXDK Repo
    #  uses: actions/checkout@v4
    #  with:
    #    repository: XboxDev/nxdk
    #    path: "$NXDK_DIR"

    - name: Build NXDK
      shell: bash
      run: PATH="${NXDK_DIR}/bin:$PATH" make -j $(nproc) -C "$NXDK_DIR" NXDK_ONLY=0 LTO=1 all cxbe

    #- name: Print text
    #  shell: bash
    #  run: cat /opt/nxdk/share/toolchain-nxdk.cmake

    - name: Configure CMake
      working-directory: ${{github.workspace}}
      run: cmake -S. -Bbuild-xbox ${{ matrix.cmakeargs }} -DNXDK=ON -DDEVILUTIONX_SYSTEM_SDL2=OFF -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DCMAKE_TOOLCHAIN_FILE=/opt/nxdk/share/toolchain-nxdk.cmake

    - name: Build
      working-directory: ${{github.workspace}}
      shell: bash
      run: cmake --build build-xbox -j $(nproc) --target package --config ${{env.BUILD_TYPE}}

    #- name: Upload-Package
    #  if: ${{ !env.ACT }}
    #  uses: actions/upload-artifact@v4
    #  with:
    #    name: ${{ matrix.artifact }}
    #    path: build-xbox/pkg/default.xbe

    #- name: Show content of workspace
    #  run: find $RUNNER_WORKSPACE
    #  shell: bash

    - name: Upload-Package
      if: ${{ !env.ACT }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}.zip
        path: build-xbox/devilutionx.zip
