name: Windows 9x MinGW

# When creating a new workflow in GitHubâ€™s action builder the default trigger is the push event. We want to extend this to push and pull request events.
on: [push, pull_request]

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release
  buildDir: '${{ github.workspace }}/build'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Create Build Environment
      run: >
        sudo apt-get update &&
        sudo apt-get install -y cmake gcc-mingw-w64-i686 g++-mingw-w64-i686 mingw-w64-tools libz-mingw-w64-dev gettext dpkg-dev wget git sudo &&
        sudo rm /usr/i686-w64-mingw32/lib/libz.dll.a &&
        sudo Packaging/windows/mingw9x-prep.sh

    - name: Show winbaseh
      run: cat /usr/share/mingw-w64/include/winbase.h
      shell: bash

    - name: Show minwinbaseh
      run: cat /usr/share/mingw-w64/include/minwinbase.h
      shell: bash

    - name: Configure CMake
      shell: bash
      working-directory: ${{ env.buildDir }}
      #run: cmake .. -DDEVILUTIONX_SYSTEM_LIBSODIUM=OFF -DNONET=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=../CMake/mingw9x.toolchain.cmake -DTARGET_PLATFORM=windows9x
      run: cmake .. -DDEVILUTIONX_SYSTEM_LIBSODIUM=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=../CMake/mingw9x.toolchain.cmake -DTARGET_PLATFORM=windows9x

    - name: Build
      working-directory: ${{ env.buildDir }}
      shell: bash
      run: cmake --build . -j $(nproc) --target package

    - name: Show content of workspace
      run: find $RUNNER_WORKSPACE
      shell: bash

    - name: Show compile commands
      run: cat ${{ env.buildDir }}/compile_commands.json
      shell: bash

    #- name: Release
    #  uses: softprops/action-gh-release@v1
    #  if: startsWith(github.ref, 'refs/tags/')
    #  with:
    #    files: ${{github.workspace}}/build/devilutionx.zip
    #  env:
    #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    # Upload the created artifact
    - name: Upload
      uses: actions/upload-artifact@v3
      with:
        path: ${{ env.buildDir }}/devilutionx.zip
        name: devilutionx-win9x.zip
